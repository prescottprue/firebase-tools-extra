#!/usr/bin/env node
/* eslint-disable consistent-return, @typescript-eslint/no-var-requires, @typescript-eslint/explicit-function-return-type */
const yargs = require('yargs');
const firestoreAction = require('../lib').default;
const { rtdbAction } = require('../lib');

const commands = [
  {
    command: 'firestore [action] [actionPath] [fixturePath]',
    describe: 'run action on Firebase using service account',
    builder: (yargsInstance) => {
      yargsInstance.positional('action', {
        describe: 'action to run on Firestore',
        default: 'set'
      });
      yargsInstance.positional('actionPath', {
        describe: 'path of action to run on Firestore',
        default: 'projects/test-project'
      });
      yargsInstance.positional('fixturePath', {
        describe: 'path of fixture to use ',
        default: 'fakeProject.json'
      });
    },
    handler: (argv) => {
      // Log if verbose option is passed
      if (argv.verbose) {
        /* eslint-disable no-console */
        console.info(
          `firestore command on :${argv.action} at ${argv.actionPath}`
        );
        /* eslint-enable no-console */
      }
      return argv;
    }
  },
  {
    command: 'database:get [actionPath] [fixturePath]',
    describe: 'run action on Firebase using service account',
    builder: (yargsInstance) => {
      yargsInstance.positional('actionPath', {
        describe: 'path of action to run on Firestore',
        default: 'projects/test-project'
      });
      yargsInstance.positional('fixturePath', {
        describe: 'path of fixture to use ',
        default: 'fakeProject.json'
      });
    }
  },
  {
    command: 'database:set [actionPath] [fixturePath]',
    describe: 'run action on Firebase using service account',
    builder: (yargsInstance) => {
      yargsInstance.positional('actionPath', {
        describe: 'path of action to run on Firestore',
        default: 'projects/test-project'
      });
      yargsInstance.positional('fixturePath', {
        describe: 'path of fixture to use ',
        default: 'fakeProject.json'
      });
    }
  },
  {
    command: 'database:update [actionPath] [fixturePath]',
    describe: 'run action on Firebase using service account',
    builder: (yargsInstance) => {
      yargsInstance.positional('actionPath', {
        describe: 'path of action to run on Firestore',
        default: 'projects/test-project'
      });
      yargsInstance.positional('fixturePath', {
        describe: 'path of fixture to use ',
        default: 'fakeProject.json'
      });
    }
  },
  {
    command: 'database:delete [actionPath] [fixturePath]',
    describe: 'run action on Firebase using service account',
    builder: (yargsInstance) => {
      yargsInstance.positional('actionPath', {
        describe: 'path of action to run on Firestore',
        default: 'projects/test-project'
      });
      yargsInstance.positional('fixturePath', {
        describe: 'path of fixture to use ',
        default: 'fakeProject.json'
      });
    }
  }
];

(function runFirebaseExtra() {
  let currentArgs;
  try {
    // TODO: Replace with commandDir when moving config to a directory
    /* eslint-disable guard-for-in, no-restricted-syntax */
    for (const command in commands) {
      /* eslint-enable guard-for-in, no-restricted-syntax */
      currentArgs = yargs.command(command);
    }
    yargs.option('withMeta', {
      alias: 'm',
      default: false
    });
    /* eslint-disable no-unused-expressions */
    const {argv} = currentArgs.option('verbose', {
      alias: 'v',
      default: false
    });
    const args = argv._ || []
    if (args[0] === 'firestore') {
      return firestoreAction(...args.slice(1));
    }
    return rtdbAction(args[0].split(':')[1], ...args.slice(1));
    /* eslint-enable no-unused-expressions */
  } catch (err) {
    /* eslint-disable no-console */
    console.error(`Error running firebase action: ${err.message || 'Error'} ${err.stack}`);
    /* eslint-enable no-console */
    process.exit(1);
  }
}());
